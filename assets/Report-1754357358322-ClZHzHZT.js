import{j as e}from"./ui-vendor-1754357358322-Bp-UNE15.js";import{r as t}from"./react-vendor-1754357358322-BCu8432v.js";import{C as r,a as s,b as a,c as o}from"./card-1754357358322-jzcAFHNM.js";import{u as l,a as d,b as n,g as c,I as i,B as m,c as u}from"./index-1754357358322-CldQuBx-.js";import{L as p}from"./label-1754357358322-2ywHf4zy.js";import{S as h,a as x,b as j,c as g,d as v}from"./select-1754357358322-DTWo5oSS.js";import{T as _,a as f,b,c as y,d as w,e as N}from"./table-1754357358322-C8S8WM1D.js";import{B as S}from"./badge-1754357358322-C6KBoXlc.js";import{F as C,J as k,G as F,b as U}from"./icons-vendor-1754357358322-D5w6PadE.js";import"./utils-vendor-1754357358322-CYErry0n.js";import"./query-vendor-1754357358322-D8Bw-8e5.js";function L(){const{user:L}=l(),{toast:D}=d(),{t:R}=n(),[E,P]=t.useState(""),[T,O]=t.useState(""),[$,I]=t.useState("all"),[M,q]=t.useState("both"),[Y,B]=t.useState([]),[G,A]=t.useState([]),[V,X]=t.useState(!1),[J,K]=t.useState(!1),[z,H]=t.useState({});t.useEffect(()=>{Q();const e=new Date,t=new Date(e.getFullYear(),e.getMonth(),1),r=new Date(e.getFullYear(),e.getMonth()+1,0);P(t.toISOString().split("T")[0]),O(r.toISOString().split("T")[0])},[]);const Q=async()=>{try{const e=await c();if(e.success&&e.users){const t=e.users.filter(e=>"exco_user"===e.role);B(t);const r={};e.users.forEach(e=>{r[e.id]=e.full_name||e.full_name||e.email||e.id}),H(r)}}catch(e){D({title:R("common.error"),description:"Failed to fetch users",variant:"destructive"})}},W=e=>({draft:"status.draft",under_review:"status.under_review",query:"status.query",query_answered:"status.query_answered",complete_can_send_to_mmk:"status.complete_can_send_to_mmk",under_review_by_mmk:"status.under_review_by_mmk",document_accepted_by_mmk:"status.document_accepted_by_mmk",payment_in_progress:"status.payment_in_progress",payment_completed:"status.payment_completed",rejected:"status.rejected"}[e]||"status.draft"),Z=e=>new Intl.NumberFormat("ms-MY",{style:"currency",currency:"MYR"}).format(e),ee=e=>new Date(e).toLocaleDateString("ms-MY"),te=G.reduce((e,t)=>{const r=z[t.created_by]||t.created_by;return e[r]||(e[r]=[]),e[r].push(t),e},{});return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-foreground",children:"SISTEM PENGURUSAN PERUNTUKAN EXCO"}),e.jsx("p",{className:"text-muted-foreground mt-1",children:"exco_user"===(null==L?void 0:L.role)?"Generate and download reports for your own programs based on date range and "+("both"===M?"approved & rejected status":"approved"===M?"approved status only":"rejected status only"):"Generate and download program reports based on date range and "+("both"===M?"approved & rejected status":"approved"===M?"approved status only":"rejected status only")})]}),e.jsxs(r,{children:[e.jsx(s,{children:e.jsxs(a,{className:"flex items-center gap-2",children:[e.jsx(C,{className:"h-5 w-5"}),R("report.title")," Configuration"]})}),e.jsxs(o,{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{htmlFor:"startDate",children:R("report.start_date")}),e.jsxs("div",{className:"relative cursor-pointer border rounded-md p-3 hover:bg-muted/50 transition-colors",onClick:()=>{var e;const t=document.getElementById("startDate");t&&(t.focus(),null==(e=t.showPicker)||e.call(t))},children:[e.jsx(k,{className:"absolute left-3 top-3 h-4 w-4 text-muted-foreground"}),e.jsx(i,{id:"startDate",type:"date",value:E,onChange:e=>P(e.target.value),className:"pl-10 border-0 bg-transparent focus:ring-0 focus:border-0 cursor-pointer",onFocus:e=>{var t,r;return null==(r=(t=e.target).showPicker)?void 0:r.call(t)}})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{htmlFor:"endDate",children:R("report.end_date")}),e.jsxs("div",{className:"relative cursor-pointer border rounded-md p-3 hover:bg-muted/50 transition-colors",onClick:()=>{var e;const t=document.getElementById("endDate");t&&(t.focus(),null==(e=t.showPicker)||e.call(t))},children:[e.jsx(k,{className:"absolute left-3 top-3 h-4 w-4 text-muted-foreground"}),e.jsx(i,{id:"endDate",type:"date",value:T,onChange:e=>O(e.target.value),className:"pl-10 border-0 bg-transparent focus:ring-0 focus:border-0 cursor-pointer",onFocus:e=>{var t,r;return null==(r=(t=e.target).showPicker)?void 0:r.call(t)}})]})]})]}),"exco_user"!==(null==L?void 0:L.role)&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{htmlFor:"userSelect",children:R("report.select_user")}),e.jsxs(h,{value:$,onValueChange:I,children:[e.jsx(x,{children:e.jsx(j,{placeholder:R("report.select_user")})}),e.jsxs(g,{children:[e.jsx(v,{value:"all",children:R("report.all_users")}),Y.map(t=>e.jsx(v,{value:t.id,children:t.full_name},t.id))]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{htmlFor:"statusSelect",children:R("report.select_status")}),e.jsxs(h,{value:M,onValueChange:q,children:[e.jsx(x,{children:e.jsx(j,{placeholder:R("report.select_status")})}),e.jsxs(g,{children:[e.jsx(v,{value:"both",children:R("report.both")}),e.jsx(v,{value:"approved",children:R("report.approved")}),e.jsx(v,{value:"rejected",children:R("report.rejected")})]})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(m,{onClick:async()=>{if(E&&T){X(!0);try{const e=new URLSearchParams({start_date:E,end_date:T,user_id:"exco_user"===(null==L?void 0:L.role)?L.id:$,status_filter:M}),t=await fetch(`${u}/report.php?${e}`),r=await t.json();r.success?(A(r.programs||[]),D({title:R("common.success"),description:"Report generated successfully"})):D({title:R("common.error"),description:r.message||"Failed to generate report",variant:"destructive"})}catch(e){D({title:R("common.error"),description:"Failed to generate report",variant:"destructive"})}finally{X(!1)}}else D({title:R("common.error"),description:"Please select both start and end dates",variant:"destructive"})},disabled:V||!E||!T,className:"flex items-center gap-2",children:[e.jsx(C,{className:"h-4 w-4"}),R(V?"common.loading":"report.generate_report")]}),G.length>0&&e.jsxs(m,{onClick:async()=>{if(0!==G.length){K(!0);try{const e=new URLSearchParams({start_date:E,end_date:T,user_id:"exco_user"===(null==L?void 0:L.role)?L.id:$,status_filter:M,download:"1"}),t=await fetch(`${u}/report.php?${e}`),r=await t.blob(),s=window.URL.createObjectURL(r),a=document.createElement("a");a.href=s,a.download=`program_report_${E}_to_${T}.pdf`,document.body.appendChild(a),a.click(),window.URL.revokeObjectURL(s),document.body.removeChild(a),D({title:R("common.success"),description:"Report downloaded successfully"})}catch(e){D({title:R("common.error"),description:"Failed to download report",variant:"destructive"})}finally{K(!1)}}else D({title:R("common.error"),description:"No report data to download",variant:"destructive"})},disabled:J,variant:"outline",className:"flex items-center gap-2",children:[e.jsx(F,{className:"h-4 w-4"}),R(J?"common.loading":"report.download_report")]})]})]})]}),G.length>0&&e.jsxs(r,{children:[e.jsxs(s,{children:[e.jsxs(a,{className:"flex items-center gap-2",children:[e.jsx(U,{className:"h-5 w-5"}),R("report.title")," Preview"]}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Showing programs from ",ee(E)," to ",ee(T)," |","exco_user"===(null==L?void 0:L.role)?`User: ${L.fullName||L.full_name||L.email}`:`User: ${"all"===$?"All EXCO Users":z[$]||$}`," | Status: ",R("both"===M?"report.both":"approved"===M?"report.approved":"report.rejected")]})]}),e.jsx(o,{children:e.jsxs("div",{className:"space-y-6",children:[Object.entries(te).map(([t,r])=>e.jsxs("div",{className:"space-y-4",children:[e.jsxs("h3",{className:"text-lg font-semibold text-foreground",children:[R("programs.title")," for ",t]}),e.jsx("div",{className:"rounded-md border",children:e.jsxs(_,{children:[e.jsx(f,{children:e.jsxs(b,{children:[e.jsx(y,{children:R("programs.program_name")}),e.jsx(y,{children:R("programs.budget")}),e.jsx(y,{children:R("programs.recipient_name")}),e.jsx(y,{children:R("status.letter_ref")}),e.jsx(y,{children:R("status.voucher_no")}),e.jsx(y,{children:R("status.eft_no")}),e.jsx(y,{children:R("programs.created_at")}),e.jsx(y,{children:R("programs.status")})]})}),e.jsx(w,{children:r.map(t=>{return e.jsxs(b,{children:[e.jsx(N,{className:"font-medium",children:t.program_name}),e.jsx(N,{children:Z(t.budget)}),e.jsx(N,{children:t.recipient_name}),e.jsx(N,{children:t.exco_letter_ref}),e.jsx(N,{children:t.voucher_number||"-"}),e.jsx(N,{children:t.eft_number||"-"}),e.jsx(N,{children:ee(t.created_at)}),e.jsx(N,{children:e.jsx(S,{className:(r=t.status,{payment_completed:"bg-green-100 text-green-800",rejected:"bg-red-100 text-red-800"}[r]||"bg-gray-100 text-gray-800"),children:R(W(t.status))})})]},t.id);var r})})]})}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:["Total ",R("programs.title").toLowerCase(),": ",r.length," | Total ",R("programs.budget").toLowerCase(),": ",Z(r.filter(e=>"payment_completed"===e.status).reduce((e,t)=>e+t.budget,0))]})]},t)),e.jsxs("div",{className:"border-t pt-4",children:[e.jsx("h4",{className:"font-semibold text-foreground mb-2",children:"Overall Summary"}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:["Total ",R("programs.title").toLowerCase(),": ",G.length," | Total ",R("programs.budget").toLowerCase(),": ",Z(G.filter(e=>"payment_completed"===e.status).reduce((e,t)=>e+t.budget,0))]})]})]})})]})]})}export{L as default};
